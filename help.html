<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Help — Manifest</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
 <link rel="stylesheet" href="styles/global.css"> 
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:         #0f1117;
      --surface:    #1a1d27;
      --surface2:   #22263a;
      --border:     #2a2f45;
      --amber:      #f59e0b;
      --amber-glow: rgba(245,158,11,0.12);
      --text:       #e8eaf0;
      --muted:      #6b7280;
      --success:    #10b981;
      --success-glow: rgba(16,185,129,0.12);
      --danger:     #ef4444;
      --danger-dim: rgba(239,68,68,0.12);
      --radius:     6px;
      --nav-h:      60px;
      --font-mono:  'DM Mono', monospace;
      --font-sans:  'DM Sans', sans-serif;
    }

    :root.light {
      --bg:         #f4f5f7;
      --surface:    #ffffff;
      --surface2:   #eef0f4;
      --border:     #dde0e8;
      --text:       #1a1d27;
      --muted:      #8a92a0;
      --amber-glow: rgba(180,110,0,0.08);
      --success-glow: rgba(16,185,129,0.08);
    }

    html { font-size: 15px; }
    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      padding-bottom: calc(var(--nav-h) + 16px);
      -webkit-font-smoothing: antialiased;
    }

    /* ── Page header ─────────────────────────────────────────────────── */
    .page-header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 14px 16px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .page-header h1 {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--amber);
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }
    .page-header .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--amber);
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

    /* ── Cards ───────────────────────────────────────────────────────── */
    .card {
      margin: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }
    .card-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }
    .card-header h2 {
      font-family: var(--font-mono);
      font-size: 0.72rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .card-body { padding: 16px; }

    /* ── Data card ───────────────────────────────────────────────────── */
    .data-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .data-cell {
      background: var(--surface2);
      padding: 12px;
      text-align: center;
    }
    .data-val {
      font-family: var(--font-mono);
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--amber);
      display: block;
    }
    .data-label {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      margin-top: 3px;
      display: block;
    }

    /* ── Backup / Restore buttons ────────────────────────────────────── */
    .action-pair {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 16px 10px;
      border-radius: var(--radius);
      cursor: pointer;
      border: none;
      font-family: var(--font-sans);
      transition: opacity 0.15s, transform 0.1s;
    }
    .action-btn:active { transform: scale(0.97); }
    .action-btn .ab-icon { font-size: 1.6rem; line-height: 1; }
    .action-btn .ab-label {
      font-size: 0.82rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .action-btn .ab-sub {
      font-family: var(--font-mono);
      font-size: 0.62rem;
      opacity: 0.7;
    }

    .btn-backup {
      background: var(--amber-glow);
      border: 1px solid rgba(245,158,11,0.25);
      color: var(--amber);
    }
    .btn-backup:hover { opacity: 0.85; }

    .btn-restore {
      background: var(--success-glow);
      border: 1px solid rgba(16,185,129,0.25);
      color: var(--success);
    }
    .btn-restore:hover { opacity: 0.85; }

    /* ── Reset ───────────────────────────────────────────────────────── */
    .reset-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: var(--danger-dim);
      border: 1px solid rgba(239,68,68,0.2);
      border-radius: var(--radius);
      color: var(--danger);
      font-family: var(--font-sans);
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
    }
    .reset-btn:active { transform: scale(0.97); }
    .reset-btn:hover  { opacity: 0.85; }

    /* ── Quick ref ───────────────────────────────────────────────────── */
    .quick-ref {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .qr-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .qr-row:last-child { border-bottom: none; }
    .qr-icon {
      font-size: 1rem;
      line-height: 1.4;
      flex-shrink: 0;
      width: 22px;
      text-align: center;
    }
    .qr-text {}
    .qr-title {
      font-size: 0.84rem;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .qr-desc {
      font-size: 0.78rem;
      color: var(--muted);
      line-height: 1.5;
    }

    /* ── Contact ─────────────────────────────────────────────────────── */
    .contact-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .contact-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      text-decoration: none;
      color: var(--text);
      font-size: 0.84rem;
      transition: border-color 0.15s;
    }
    .contact-link:hover { border-color: var(--amber); }
    .contact-link .cl-icon { font-size: 1rem; flex-shrink: 0; }
    .contact-link .cl-val {
      font-family: var(--font-mono);
      font-size: 0.78rem;
      color: var(--amber);
    }

    /* ── Version ─────────────────────────────────────────────────────── */
    .version-line {
      text-align: center;
      padding: 16px;
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: var(--muted);
      letter-spacing: 0.08em;
    }

    /* ── Toast ───────────────────────────────────────────────────────── */
    #toast {
      position: fixed;
      bottom: calc(var(--nav-h) + 12px);
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 18px;
      font-size: 0.82rem;
      color: var(--text);
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
      white-space: nowrap;
      z-index: 100;
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    #toast.success { border-color: var(--success); color: var(--success); }
    #toast.error   { border-color: var(--danger);  color: var(--danger);  }

    /* ── Bottom nav ──────────────────────────────────────────────────── */
    .bottom-nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: var(--nav-h);
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: stretch;
      z-index: 20;
    }
    .bottom-nav a {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      gap: 3px;
      font-family: var(--font-mono);
      font-size: 0.6rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      transition: color 0.15s;
      position: relative;
    }
    .bottom-nav a .nav-icon { font-size: 1.1rem; line-height: 1; }
    .bottom-nav a:hover { color: var(--text); }
    .bottom-nav a.active { color: var(--amber); }
    .bottom-nav a.active::before {
      content: '';
      position: absolute;
      top: 0; left: 20%; right: 20%;
      height: 2px;
      background: var(--amber);
      border-radius: 0 0 3px 3px;
    }

    /* ── DB loader ───────────────────────────────────────────────────── */
    #db-loader {
      position: fixed; inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
      z-index: 200;
      transition: opacity 0.3s;
    }
    #db-loader.hidden { opacity: 0; pointer-events: none; }
    .loader-ring {
      width: 36px; height: 36px;
      border: 2px solid var(--border);
      border-top-color: var(--amber);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #db-loader p {
      font-family: var(--font-mono);
      font-size: 0.72rem;
      color: var(--muted);
      letter-spacing: 0.1em;
    }

    /* ── Responsive ──────────────────────────────────────────────────── */
    @media (min-width: 600px) {
      .card { max-width: 480px; margin-left: auto; margin-right: auto; }
      .page-header { justify-content: center; }
      .version-line { max-width: 480px; margin: 0 auto; }
    }
  </style>
</head>
<body>

<div id="db-loader">
  <div class="loader-ring"></div>
  <p>LOADING DATABASE...</p>
</div>

<header class="page-header">
  <div class="dot"></div>
  <h1>Help</h1>
  <button onclick="toggleTheme()" title="Toggle theme" style="margin-left:auto;background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:4px;padding:4px 10px;font-size:1rem;line-height:1;cursor:pointer">&#9680;</button>
</header>

<!-- Data snapshot -->
<div class="card">
  <div class="card-header"><h2>Your Data</h2></div>
  <div class="card-body">
    <div class="data-grid">
      <div class="data-cell">
        <span class="data-val" id="snapTrips">—</span>
        <span class="data-label">Trips</span>
      </div>
      <div class="data-cell">
        <span class="data-val" id="snapPax">—</span>
        <span class="data-label">Passengers</span>
      </div>
      <div class="data-cell">
        <span class="data-val" id="snapRoutes">—</span>
        <span class="data-label">Routes</span>
      </div>
    </div>

    <div class="action-pair">
      <button class="action-btn btn-backup" onclick="backup()">
        <span class="ab-icon">⤓</span>
        <span class="ab-label">Backup</span>
        <span class="ab-sub">.db file</span>
      </button>
      <button class="action-btn btn-restore" onclick="triggerRestore()">
        <span class="ab-icon">⤒</span>
        <span class="ab-label">Restore</span>
        <span class="ab-sub">from file</span>
      </button>
    </div>
    <input type="file" id="restoreInput" accept=".db" style="display:none" onchange="restore(event)" />
  </div>
</div>

<!-- Quick reference -->
<div class="card">
  <div class="card-header"><h2>Quick Reference</h2></div>
  <div class="card-body" style="padding: 0 16px;">
    <div class="quick-ref">
      <div class="qr-row">
        <span class="qr-icon">⚙</span>
        <div class="qr-text">
          <div class="qr-title">Config first</div>
          <div class="qr-desc">Add vehicles and routes before booking. Places are auto-saved when you type them in route config.</div>
        </div>
      </div>
      <div class="qr-row">
        <span class="qr-icon">⊞</span>
        <div class="qr-text">
          <div class="qr-title">One trip, many passengers</div>
          <div class="qr-desc">Keep the same booking code for a full vehicle. Hit New Trip only when starting a fresh departure.</div>
        </div>
      </div>
      <div class="qr-row">
        <span class="qr-icon">◫</span>
        <div class="qr-text">
          <div class="qr-title">Manifest & print</div>
          <div class="qr-desc">Enter any booking code on the Manifest page. Use Print or Share to hand off to the driver.</div>
        </div>
      </div>
      <div class="qr-row">
        <span class="qr-icon">◷</span>
        <div class="qr-text">
          <div class="qr-title">History filters</div>
          <div class="qr-desc">Filter by date or route. Tap any trip card to expand passenger details and view its manifest.</div>
        </div>
      </div>
      <div class="qr-row">
        <span class="qr-icon">⤓</span>
        <div class="qr-text">
          <div class="qr-title">Backup regularly</div>
          <div class="qr-desc">Your data lives in this browser only. Backup exports the full database as a single .db file you can store anywhere.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Reset -->
<div class="card">
  <div class="card-header"><h2>Danger Zone</h2></div>
  <div class="card-body">
    <button class="reset-btn" onclick="resetAll()">
      ⚠ Reset All Data
    </button>
  </div>
</div>

<!-- Contact -->
<div class="card">
  <div class="card-header"><h2>Support</h2></div>
  <div class="card-body">
    <div class="contact-links">
      <a class="contact-link" href="mailto:edmundsparrow@gmail.com">
        <span class="cl-icon">✉</span>
        <div>
          <div style="font-size:0.72rem;color:var(--muted);margin-bottom:2px">Email</div>
          <div class="cl-val">edmundsparrow@gmail.com</div>
        </div>
      </a>
      <a class="contact-link" href="https://t.me/EdmundSparrow" target="_blank">
        <span class="cl-icon">✈</span>
        <div>
          <div style="font-size:0.72rem;color:var(--muted);margin-bottom:2px">Telegram</div>
          <div class="cl-val">@EdmundSparrow</div>
        </div>
      </a>
    </div>
  </div>
</div>

<div class="version-line">MANIFEST APP · v2.0 · DATA STAYS ON YOUR DEVICE</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Bottom nav -->
<nav class="bottom-nav">
  <a href="main.html">
    <span class="nav-icon">⊞</span>Booking
  </a>
  <a href="preview.html">
    <span class="nav-icon">◫</span>Manifest
  </a>
  <a href="history.html">
    <span class="nav-icon">◷</span>History
  </a>
  <a href="config.html">
    <span class="nav-icon">⚙</span>Config
  </a>
  <a href="help.html" class="active">
    <span class="nav-icon">?</span>Help
  </a>
</nav>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
<script src="scripts/db-core.js"></script>

<script>
/* ── Theme ──────────────────────────────────────────────────────────── */
function toggleTheme() {
  const isLight = document.documentElement.classList.toggle('light');
  localStorage.setItem('manifest-theme', isLight ? 'light' : 'dark');
}
(function loadTheme() {
  if (localStorage.getItem('manifest-theme') === 'light')
    document.documentElement.classList.add('light');
})();

/* ── Toast ──────────────────────────────────────────────────────────── */
let _tt;
function toast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `show ${type}`;
  clearTimeout(_tt);
  _tt = setTimeout(() => el.className = '', 2600);
}

/* ── Data snapshot ──────────────────────────────────────────────────── */
function renderSnapshot() {
  const trips  = DB.query('SELECT COUNT(*) AS n FROM trips')[0]?.n  ?? 0;
  const pax    = DB.query('SELECT COUNT(*) AS n FROM passengers')[0]?.n ?? 0;
  const routes = DB.query('SELECT COUNT(*) AS n FROM routes')[0]?.n  ?? 0;
  document.getElementById('snapTrips').textContent  = trips;
  document.getElementById('snapPax').textContent    = pax;
  document.getElementById('snapRoutes').textContent = Math.floor(routes / 2); // pairs
}

/* ── Backup ─────────────────────────────────────────────────────────── */
function backup() {
  try {
    const date = new Date().toISOString().slice(0, 10);
    DB.exportDB(`manifest-backup-${date}.db`);
    toast('Backup downloaded', 'success');
  } catch (e) {
    toast('Backup failed: ' + e.message, 'error');
  }
}

/* ── Restore ────────────────────────────────────────────────────────── */
function triggerRestore() {
  document.getElementById('restoreInput').click();
}

async function restore(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (!file.name.endsWith('.db')) {
    toast('Select a valid .db file', 'error'); return;
  }
  if (!confirm('Restore will replace all current data with the backup. Continue?')) {
    e.target.value = ''; return;
  }
  try {
    await DB.restoreDB(file);
    toast('Restore successful — reloading...', 'success');
    setTimeout(() => window.location.reload(), 1200);
  } catch (err) {
    toast('Restore failed: ' + err.message, 'error');
  }
  e.target.value = '';
}

/* ── Reset all ──────────────────────────────────────────────────────── */
async function resetAll() {
  if (!confirm('This will permanently delete ALL trips, passengers, routes, vehicles and company data. Are you sure?')) return;
  if (!confirm('Final confirmation — this cannot be undone.')) return;
  try {
    const tables = ['passengers','trips','drivers','routes','places','vehicles','company'];
    for (const t of tables) {
      await DB.run(`DELETE FROM ${t}`);
    }
    localStorage.removeItem('manifest_activeCode');
    toast('All data cleared', 'success');
    renderSnapshot();
  } catch (e) {
    toast('Reset failed: ' + e.message, 'error');
  }
}

/* ── Init ───────────────────────────────────────────────────────────── */
async function init() {
  try {
    await DB.init({
      locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}`
    });
    renderSnapshot();
  } catch (e) {
    document.getElementById('db-loader').querySelector('p').textContent = 'ERROR: ' + e.message;
    return;
  }
  const loader = document.getElementById('db-loader');
  loader.classList.add('hidden');
  setTimeout(() => loader.remove(), 400);
}

init();
</script>
</body>
</html>
